{% extends "base.html" %}

{% block title %}Mis Reservaciones - Pringamosa Hotel Boutique{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row">
        <!-- Sidebar -->
        {% include 'guest/sidebar.html' %}

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 bg-white main-content">
            <div class="container py-4">
                <div class="row">
                    <div class="col-12">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <h1 class="h3 text-primary fw-bold mb-0">Mis Reservaciones</h1>
                                            <div class="d-flex gap-2 flex-wrap">
                                                <a href="{{ url_for('guest.reserve') }}" class="btn btn-primary">
                                                    <i class="fas fa-plus me-2"></i>Nueva Reservación
                                                </a>
                                                <a href="{{ url_for('guest.dashboard') }}" class="btn btn-primary">
                                                    <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                                                </a>
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </div>

    {# Mapa de estados para mostrar en español (seguro ante valores en inglés/español) #}
    {% set status_map = {
        'pending': 'Pendiente', 'pendiente': 'Pendiente',
        'confirmed': 'Confirmada', 'confirmada': 'Confirmada',
        'completed': 'Completada', 'completada': 'Completada',
        'cancelled': 'Cancelada', 'cancelada': 'Cancelada'
    } %}

    {# Macro para obtener la imagen de la habitación de forma segura #}
    {% macro room_image(reservation) %}
        {% set img = None %}
        {% if reservation.room %}
            {# intenta distintos accesos comunes #}
            {% if reservation.room.get_image_path is defined %}
                {% set img = reservation.room.get_image_path() %}
            {% elif reservation.room.image_url is defined %}
                {% set img = reservation.room.image_url %}
            {% elif reservation.room.image is defined %}
                {% set img = reservation.room.image %}
            {% endif %}
        {% endif %}

        {% if img %}
            {% if img.startswith('http') %}
                <img src="{{ img }}" class="card-img-top" alt="Habitación {{ reservation.room.number }}">
            {% else %}
                <img src="{{ url_for('static', filename=img) }}" class="card-img-top" alt="Habitación {{ reservation.room.number }}">
            {% endif %}
        {% else %}
            <img src="{{ url_for('static', filename='img/default-room.jpg') }}" class="card-img-top" alt="Habitación {{ reservation.room.number }}">
        {% endif %}
    {% endmacro %}

    <!-- Filter Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="reservationTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                        Todas
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                        Pendientes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button">
                        Confirmadas
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                        Completadas
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="reservationTabsContent">
                <!-- Todas -->
                <div class="tab-pane fade show active" id="all">
                    <div class="row g-4">
                        {% for reservation in reservations %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100">
                                {{ room_image(reservation) }}
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">Reservación</h5>
                                    <p class="card-text">
                                        <strong>Habitación:</strong>
                                        {{ reservation.room.number if reservation.room else 'N/A' }}
                                        {% if reservation.room %} - {{ reservation.room.get_type_display() }}{% endif %}<br>
                                        <strong>Entrada:</strong> {{ reservation.check_in_date.strftime('%d/%m/%Y') }}<br>
                                        <strong>Salida:</strong> {{ reservation.check_out_date.strftime('%d/%m/%Y') }}<br>
                                        <strong>Estado:</strong>
                                        {% set disp = status_map.get(reservation.status) %}
                                        {% if not disp and reservation.get_status_display is defined %}
                                            {% set disp = reservation.get_status_display() %}
                                        {% endif %}
                                        <span class="badge
                                            {% if reservation.status in ['pending','pendiente'] %} bg-secondary text-dark
                                            {% elif reservation.status in ['confirmed','confirmada'] %} bg-success
                                            {% elif reservation.status in ['completed','completada'] %} bg-primary
                                            {% elif reservation.status in ['cancelled','cancelada'] %} bg-danger
                                            {% else %} bg-secondary {% endif %}">
                                            {{ disp or reservation.status }}
                                        </span>
                                    </p>
                                    <div class="mt-auto">
                                        <a href="{{ url_for('guest.view_reservation', id=reservation.id) }}" class="btn btn-outline-primary btn-sm">
                                            Ver
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if reservations|length == 0 %}
                        <div class="col-12 text-center text-muted py-5">
                            No tienes reservaciones registradas.
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Pendientes -->
                <div class="tab-pane fade" id="pending">
                    <div class="row g-4">
                        {% set pending_states = ['pendiente', 'pending'] %}
                        {% set found = false %}
                        {% for reservation in reservations if reservation.status in pending_states %}
                        {% set found = true %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card border-secondary h-100">
                                {{ room_image(reservation) }}
                                <div class="card-body">
                                    <h5 class="card-title">Reservación</h5>
                                    <p>
                                        <strong>Entrada:</strong> {{ reservation.check_in_date.strftime('%d/%m/%Y') }}<br>
                                        <strong>Salida:</strong> {{ reservation.check_out_date.strftime('%d/%m/%Y') }}
                                    </p>
                                    <p><span class="badge bg-secondary text-dark">{{ status_map.get(reservation.status, 'Pendiente') }}</span></p>
                                    <a href="{{ url_for('guest.view_reservation', id=reservation.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not found %}
                        <div class="col-12 text-center text-muted py-4">No tienes reservaciones pendientes.</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Confirmadas -->
                <div class="tab-pane fade" id="confirmed">
                    <div class="row g-4">
                        {% set confirmed_states = ['confirmada', 'confirmed'] %}
                        {% set found = false %}
                        {% for reservation in reservations if reservation.status in confirmed_states %}
                        {% set found = true %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card border-success h-100">
                                {{ room_image(reservation) }}
                                <div class="card-body">
                                    <h5 class="card-title">Reservación</h5>
                                    <p><span class="badge bg-success">{{ status_map.get(reservation.status, 'Confirmada') }}</span></p>
                                    <p>
                                        <strong>Entrada:</strong> {{ reservation.check_in_date.strftime('%d/%m/%Y') }}<br>
                                        <strong>Salida:</strong> {{ reservation.check_out_date.strftime('%d/%m/%Y') }}
                                    </p>
                                    <a href="{{ url_for('guest.view_reservation', id=reservation.id) }}" class="btn btn-sm btn-outline-success">Ver</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not found %}
                        <div class="col-12 text-center text-muted py-4">No tienes reservaciones confirmadas.</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Completadas -->
                <div class="tab-pane fade" id="completed">
                    <div class="row g-4">
                        {% set completed_states = ['completada', 'completed'] %}
                        {% set found = false %}
                        {% for reservation in reservations if reservation.status in completed_states %}
                        {% set found = true %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card border-primary h-100">
                                {{ room_image(reservation) }}
                                <div class="card-body">
                                    <h5 class="card-title">Reservación</h5>
                                    <p><span class="badge bg-primary">{{ status_map.get(reservation.status, 'Completada') }}</span></p>
                                    <p>
                                        <strong>Entrada:</strong> {{ reservation.check_in_date.strftime('%d/%m/%Y') }}<br>
                                        <strong>Salida:</strong> {{ reservation.check_out_date.strftime('%d/%m/%Y') }}
                                    </p>
                                    <a href="{{ url_for('guest.view_reservation', id=reservation.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not found %}
                        <div class="col-12 text-center text-muted py-4">No tienes reservaciones completadas.</div>
                        {% endif %}
                    </div>
                </div>

            </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card.h-100 { border-radius: 12px; overflow: hidden; }
.card-img-top { height: 170px; object-fit: cover; }
.card-body { min-height: 160px; }
</style>
{% endblock %}
