{% extends "base.html" %}

{% block title %}Nuevo Check-in - Recepcionista{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-primary mb-4">Nuevo Check-in</h2>

    <!-- Botón volver al dashboard -->
    <a href="{{ url_for('receptionist.dashboard') }}" class="btn btn-secondary mb-3">
        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
    </a>

    <!-- Buscar huésped por correo -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="fas fa-search me-2"></i>Buscar Huésped
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('receptionist.new_checkin') }}">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.guest_email.label(class="form-label") }}
                    {{ form.guest_email(class="form-control", placeholder="Correo del huésped") }}
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-search me-2"></i>Buscar</button>
            </form>
        </div>
    </div>

    {% if guest %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="fas fa-user me-2"></i>Huésped Encontrado: {{ guest.get_full_name() }}
        </div>
        <div class="card-body">
            {% if guest_reservations %}
            <h5>Reservas Activas del Huésped</h5>
            <div class="list-group mb-3">
                {% for res in guest_reservations %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        Habitación {{ res.room.number }} | Estado: {{ res.status }} | Check-in: {{ res.check_in_date }} | Check-out: {{ res.check_out_date }}
                    </div>
                    {% if res.status == 'confirmada' %}
                    <a href="{{ url_for('receptionist.checkin', reservation_id=res.id) }}" class="btn btn-success btn-sm">
                        Realizar Check-in
                    </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">El huésped no tiene reservas activas. Puedes asignarle una habitación disponible para check-in desde cero.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Habitaciones disponibles para check-in -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-bed me-2"></i>Habitaciones Disponibles
        </div>
        <div class="card-body">
            {% if rooms %}
            <div class="row g-3">
                {% for room in rooms %}
                <div class="col-md-4">
                    <div class="card h-100">
                        <img src="{{ url_for('static', filename=room.get_image_path()) }}"
                             class="card-img-top" style="height:200px; object-fit:cover;"
                             alt="Habitación {{ room.number }}">
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ room.number }} - {{ room.get_type_display() }}</h5>
                            <p class="card-text">{{ room.description }}</p>
                            <p class="fw-bold">
                                Estado: 
                                {% if room.status == 'disponible' %}
                                    <span class="text-success">{{ room.status }}</span>
                                {% elif room.status == 'ocupada' %}
                                    <span class="text-danger">{{ room.status }}</span>
                                {% else %}
                                    <span class="text-warning">{{ room.status }}</span>
                                {% endif %}
                            </p>
                            {% if guest %}
                            <a href="{{ url_for('receptionist.checkin_select_room', guest_id=guest.id, room_id=room.id, check_out_date=datetime.now().strftime('%Y-%m-%d')) }}"
                               class="btn btn-primary btn-sm">Asignar Check-in</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No hay habitaciones disponibles.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
